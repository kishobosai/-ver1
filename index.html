<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>どこでも東京ドーム</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Tailwindのデフォルトフォントを適用 */
    body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    /* アイコンの表示スタイル調整 */
    i[data-lucide] { display: inline-block; }
    /* スマホの下部バーを回避するための安全な配置 */
    .bottom-safe {
      bottom: max(1.5rem, env(safe-area-inset-bottom, 1.5rem));
    }
    /* カスタムスクロールバー（下にスクロールできることを分かりやすくする） */
    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="relative w-full h-screen bg-[#e5e7eb] overflow-hidden">

  <!-- マップコンテナ -->
  <div id="map" class="w-full h-full absolute inset-0 z-0"></div>
  
  <!-- 中央の十字レティクル（ターゲット） -->
  <div class="absolute inset-0 pointer-events-none z-[1000] flex items-center justify-center">
    <div class="relative w-10 h-10 opacity-50">
      <div class="absolute top-1/2 left-0 w-full h-[2px] bg-gray-900 -translate-y-1/2 rounded-full"></div>
      <div class="absolute left-1/2 top-0 w-[2px] h-full bg-gray-900 -translate-x-1/2 rounded-full"></div>
      <div class="absolute inset-0 border-2 border-gray-900 rounded-full scale-50"></div>
    </div>
  </div>

  <!-- タイトル・説明パネル (左上) -->
  <div class="absolute top-2 left-2 sm:top-4 sm:left-4 z-[1000] bg-white/95 backdrop-blur-md p-3 sm:p-5 rounded-xl sm:rounded-2xl shadow-xl border border-gray-100 w-[calc(100%-16px)] sm:w-auto sm:max-w-[340px] max-h-[calc(100vh-140px)] flex flex-col pointer-events-auto transition-all duration-300">
    <!-- ヘッダー部分（常に表示） -->
    <div class="flex justify-between items-center sm:mb-2 shrink-0">
      <h1 class="text-sm sm:text-xl font-bold text-gray-800 flex items-center gap-1.5 sm:gap-2">
        <i data-lucide="tent" class="w-4 h-4 sm:w-6 sm:h-6 text-red-500 shrink-0"></i>
        <span id="app-title-text" class="truncate">どこでも東京ドーム</span>
      </h1>
      <!-- スマホ用アコーディオンボタン -->
      <button id="toggle-settings-btn" class="sm:hidden text-gray-500 p-1.5 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors active:scale-95">
        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-300" id="toggle-icon"></i>
      </button>
    </div>
    
    <!-- 設定コンテンツ部分（スクロールバーを表示するように custom-scrollbar クラスに変更） -->
    <div id="settings-content" class="hidden sm:block overflow-y-auto custom-scrollbar pt-2 sm:pt-0 pr-1">
      <div class="hidden sm:block">
        <p class="text-xs text-gray-600 mb-3 leading-relaxed">
          指定した「東京ドーム◯個分」と同じ面積を持つ図形が画面中央に表示されます。世界中の好きな場所に移動して大きさを比べてみましょう！
        </p>
      </div>

      <!-- 個数指定コントロール -->
      <div>
        <label class="block text-[10px] sm:text-xs font-semibold text-gray-500 mb-1">東京ドームの数 (最大1億個)</label>
        <div class="flex items-center gap-2 mb-2">
          <input type="number" id="dome-input" value="1" min="0.1" max="100000000" step="any" class="w-full bg-white border border-gray-300 text-gray-800 text-sm sm:text-base font-bold rounded-lg focus:ring-red-500 focus:border-red-500 block p-1.5 sm:p-2 shadow-sm outline-none transition-all text-right">
          <span class="text-sm font-bold text-gray-700 shrink-0">個分</span>
        </div>
        
        <!-- 簡単スライダー（対数スケール） -->
        <div class="mb-2">
          <input type="range" id="dome-slider" min="-1" max="8" step="0.01" value="0" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-500">
          <div class="flex justify-between text-[9px] text-gray-400 mt-0.5 font-medium px-1">
            <span>0.1個</span>
            <span>1億個</span>
          </div>
        </div>
        
        <!-- クイック選択ボタン -->
        <div class="flex flex-wrap gap-1.5 sm:gap-2">
          <button class="quick-btn text-xs font-medium bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 px-2 py-1 rounded-md transition-colors flex-1" data-val="1">1個</button>
          <button class="quick-btn text-xs font-medium bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 px-2 py-1 rounded-md transition-colors flex-1" data-val="10">10個</button>
          <button class="quick-btn text-xs font-medium bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 px-2 py-1 rounded-md transition-colors flex-1" data-val="100">100個</button>
          <button class="quick-btn text-xs font-medium bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 px-2 py-1 rounded-md transition-colors flex-1" data-val="1000">1000個</button>
        </div>
      </div>

      <!-- 変形コントロール -->
      <div class="mt-3 sm:mt-4 pt-3 border-t border-gray-100">
        <label class="block text-[10px] sm:text-xs font-semibold text-gray-500 mb-2">図形の変形 (面積は変わりません)</label>
        
        <!-- 角の数 -->
        <div class="mb-3">
          <div class="flex justify-between text-[10px] text-gray-400 mb-1 font-medium">
            <span>角の数 (三角形)</span>
            <span id="shape-name" class="text-red-500 font-bold">円</span>
          </div>
          <input type="range" id="sides-slider" min="3" max="30" value="30" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-500">
        </div>
        
        <!-- 縦横比 -->
        <div class="mb-3">
          <div class="flex justify-between text-[10px] text-gray-400 mb-1 font-medium">
            <span>縦長</span>
            <span>正比例</span>
            <span>横長</span>
          </div>
          <input type="range" id="aspect-slider" min="-100" max="100" value="0" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-500">
        </div>

        <!-- 向き（回転） -->
        <div class="mb-1">
          <div class="flex justify-between text-[10px] text-gray-400 mb-1 font-medium">
            <span>左回転</span>
            <span>向き (回転)</span>
            <span>右回転</span>
          </div>
          <input type="range" id="rotation-slider" min="-180" max="180" value="0" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-500">
        </div>
      </div>
      
      <!-- バグ報告リンク -->
      <div class="mt-3 sm:mt-4 text-right shrink-0">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfh55H0B8LKC9N7ed3hGXwA4duPPNhTMbcT6oQgCS4tX4_CjA/viewform?usp=header" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-[10px] sm:text-xs text-gray-400 hover:text-gray-600 transition-colors cursor-pointer">
          <i data-lucide="bug" class="w-3 h-3"></i>
          <span>バグ・不具合を報告</span>
        </a>
      </div>
    </div>
  </div>

  <!-- ステータスパネル (右上) スマホ時はすり抜け（pointer-events-none）にして地図操作の邪魔をしない -->
  <div class="absolute top-14 right-2 sm:top-4 sm:right-4 z-[900] bg-white/80 sm:bg-white/95 backdrop-blur-md p-2.5 sm:p-5 rounded-xl sm:rounded-2xl shadow-md sm:shadow-xl border border-gray-100 min-w-min sm:min-w-[220px] pointer-events-none sm:pointer-events-auto transition-all">
    <div class="hidden sm:block">
      <div class="text-xs font-semibold text-gray-400 tracking-wider mb-1 uppercase">現在地の中心座標</div>
      <div id="coords-display" class="font-mono text-sm text-gray-700 mb-4 bg-gray-50 p-2 rounded-lg border border-gray-100">
        N 35.706°<br/>E 139.752°
      </div>
    </div>
    
    <div class="text-[10px] sm:text-xs font-semibold text-gray-400 tracking-wider mb-1 uppercase leading-tight drop-shadow-sm sm:drop-shadow-none">
      実際の広さ
    </div>
    <div class="space-y-0.5 sm:space-y-1 drop-shadow-sm sm:drop-shadow-none">
      <div class="flex items-baseline gap-1 sm:mb-1.5">
        <span class="text-[10px] sm:text-xs text-gray-600 w-7 sm:w-10">面積:</span>
        <span id="area-display" class="text-base sm:text-2xl font-black text-red-500 tracking-tight">46,755</span>
        <span id="area-unit" class="text-[9px] sm:text-xs text-gray-500 font-medium">m²</span>
      </div>
      <div class="flex items-baseline gap-1">
        <span class="text-[10px] sm:text-xs text-gray-600 w-7 sm:w-10">横幅:</span>
        <span id="width-display" class="text-xs sm:text-base font-bold text-gray-800 tracking-tight">244</span>
        <span id="width-unit" class="text-[9px] sm:text-xs text-gray-500 font-medium">m</span>
      </div>
      <div class="flex items-baseline gap-1">
        <span class="text-[10px] sm:text-xs text-gray-600 w-7 sm:w-10">縦幅:</span>
        <span id="height-display" class="text-xs sm:text-base font-bold text-gray-800 tracking-tight">244</span>
        <span id="height-unit" class="text-[9px] sm:text-xs text-gray-500 font-medium">m</span>
      </div>
    </div>
  </div>

  <!-- コントロールボタン (下部中央) -->
  <div class="absolute left-1/2 -translate-x-1/2 z-[1000] flex gap-2 sm:gap-3 w-full max-w-[90%] sm:max-w-sm justify-center bottom-safe">
    <button id="btn-home" class="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 bg-white px-3 sm:px-4 py-2.5 sm:py-3.5 rounded-xl sm:rounded-2xl shadow-lg font-medium text-sm sm:text-base text-gray-700 hover:bg-gray-50 transition-all active:scale-95 border border-gray-200 cursor-pointer">
      <i data-lucide="tent" class="w-4 h-4 sm:w-5 sm:h-5 text-red-500"></i>
      実際の場所
    </button>
    <button id="btn-current-location" class="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 bg-blue-600 px-3 sm:px-4 py-2.5 sm:py-3.5 rounded-xl sm:rounded-2xl shadow-lg font-medium text-sm sm:text-base text-white hover:bg-blue-700 transition-all active:scale-95 cursor-pointer">
      <i data-lucide="navigation" class="w-4 h-4 sm:w-5 sm:h-5"></i>
      現在地へ
    </button>
  </div>

  <!-- トースト通知 -->
  <div id="toast" class="hidden absolute bottom-24 left-1/2 -translate-x-1/2 z-[1100] bg-gray-800/90 backdrop-blur-sm text-white px-6 py-3 rounded-full shadow-2xl text-sm font-medium animate-bounce transition-opacity">
    <span id="toast-message"></span>
  </div>

  <script>
    lucide.createIcons();

    let map = null;
    let shapeLayer = null; 
    let center = { lat: 35.7056, lng: 139.7519 };
    const L_lat = 35.7056;
    const L_lon = 139.7519;
    
    const DOME_AREA_SQM = 46755; 
    const MAX_DOME_COUNT = 100000000; // 1億個
    let currentDomeCount = 1;
    let toastTimeout = null;

    // 変形用の変数
    let shapeSides = 30; // 30は円として扱う
    let shapeAspect = 1.0; // 縦横比
    let shapeRotation = 0; // 回転（度）

    // スマホ用設定パネルの開閉ロジック
    const toggleBtn = document.getElementById('toggle-settings-btn');
    const settingsContent = document.getElementById('settings-content');
    const toggleIcon = document.getElementById('toggle-icon');

    toggleBtn.addEventListener('click', () => {
      settingsContent.classList.toggle('hidden');
      toggleIcon.classList.toggle('rotate-180');
    });

    function showToast(msg) {
      const toastEl = document.getElementById('toast');
      const msgEl = document.getElementById('toast-message');
      msgEl.innerText = msg;
      toastEl.classList.remove('hidden');
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toastEl.classList.add('hidden');
      }, 3000);
    }

    function updateUI(area, width, height) {
      const displayLat = center.lat;
      let displayLng = center.lng % 360;
      if (displayLng > 180) displayLng -= 360;
      if (displayLng < -180) displayLng += 360;

      const latText = displayLat >= 0 ? 'N' : 'S';
      const lngText = displayLng >= 0 ? 'E' : 'W';

      document.getElementById('coords-display').innerHTML = 
        `${latText} ${Math.abs(displayLat).toFixed(3)}°<br/>${lngText} ${Math.abs(displayLng).toFixed(3)}°`;
      
      const areaDisplay = document.getElementById('area-display');
      const areaUnit = document.getElementById('area-unit');
      if (area >= 1000000) {
        areaDisplay.innerText = (area / 1000000).toLocaleString(undefined, { maximumFractionDigits: 2 });
        areaUnit.innerText = 'km²';
      } else {
        areaDisplay.innerText = Math.round(area).toLocaleString();
        areaUnit.innerText = 'm²';
      }

      const updateLength = (val, dispId, unitId) => {
        const disp = document.getElementById(dispId);
        const unit = document.getElementById(unitId);
        if (val >= 1000) {
          disp.innerText = (val / 1000).toLocaleString(undefined, { maximumFractionDigits: 2 });
          unit.innerText = 'km';
        } else {
          disp.innerText = Math.round(val).toLocaleString();
          unit.innerText = 'm';
        }
      };

      updateLength(width, 'width-display', 'width-unit');
      updateLength(height, 'height-display', 'height-unit');
    }

    function updateDomeShape() {
      if (!map) return;

      const c_lat = center.lat;
      const c_lon = center.lng;
      const totalArea = DOME_AREA_SQM * currentDomeCount;
      const n = shapeSides;
      
      let R;
      if (n >= 30) {
        R = Math.sqrt(totalArea / Math.PI);
      } else {
        R = Math.sqrt((2 * totalArea) / (n * Math.sin(2 * Math.PI / n)));
      }

      const sx = Math.sqrt(shapeAspect);
      const sy = 1 / Math.sqrt(shapeAspect);

      const R_EARTH = 6378137;
      const lat1 = c_lat * Math.PI / 180;
      const lon1 = c_lon * Math.PI / 180;

      let latLngs = [];
      const vertexCount = n >= 30 ? 64 : n; 
      
      // オフセット角度にユーザー指定の回転角を加算する
      const angleOffset = ((n % 2 !== 0) ? 0 : Math.PI / n) + (shapeRotation * Math.PI / 180);

      for (let i = 0; i < vertexCount; i++) {
        const angle = i * (2 * Math.PI / vertexCount) + angleOffset;
        
        const x_meters = R * Math.sin(angle) * sx;
        const y_meters = R * Math.cos(angle) * sy;

        const d = Math.sqrt(x_meters * x_meters + y_meters * y_meters);
        const theta = Math.atan2(x_meters, y_meters); 
        const delta = d / R_EARTH;

        const lat2 = Math.asin( Math.sin(lat1)*Math.cos(delta) + Math.cos(lat1)*Math.sin(delta)*Math.cos(theta) );
        const lon2 = lon1 + Math.atan2( Math.sin(theta)*Math.sin(delta)*Math.cos(lat1), Math.cos(delta) - Math.sin(lat1)*Math.sin(lat2) );

        latLngs.push([lat2 * 180 / Math.PI, lon2 * 180 / Math.PI]);
      }

      if (!shapeLayer) {
        shapeLayer = L.polygon(latLngs, {
          color: '#ef4444',
          weight: 2,
          fillColor: '#ef4444',
          fillOpacity: 0.45,
          interactive: false
        }).addTo(map);
      } else {
        shapeLayer.setLatLngs(latLngs);
      }

      // 横幅と縦幅（回転している場合は大まかなバウンディングボックスサイズになる）
      let displayWidth = R * sx * 2;
      let displayHeight = R * sy * 2;
      
      if (n < 30 && n % 2 === 0) {
        displayWidth = displayWidth * Math.cos(Math.PI / n);
        displayHeight = displayHeight * Math.cos(Math.PI / n);
      } else if (n < 30 && n % 2 !== 0) {
        displayHeight = R * sy + R * sy * Math.cos(Math.PI / n);
      }

      updateUI(totalArea, displayWidth, displayHeight);
    }

    function onDomeCountChange(val, updateSlider = true) {
      let count = parseFloat(val);
      if (isNaN(count) || count <= 0) count = 0.1;
      if (count > MAX_DOME_COUNT) count = MAX_DOME_COUNT;
      
      currentDomeCount = count;
      document.getElementById('dome-input').value = count;
      
      if (updateSlider) {
        document.getElementById('dome-slider').value = Math.log10(count);
      }
      
      updateDomeShape();
    }

    window.onload = function() {
      map = L.map('map', {
        center: [center.lat, center.lng],
        zoom: 15,
        zoomControl: false
      });
      
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      let moveRaf = null;
      map.on('move', () => {
        const c = map.getCenter(); 
        center = { lat: c.lat, lng: c.lng };
        if (!moveRaf) {
          moveRaf = requestAnimationFrame(() => {
            updateDomeShape(); 
            moveRaf = null;
          });
        }
      });

      map.on('moveend', () => {
        const c = map.getCenter();
        const MAX_LAT = 84.5; 
        if (c.lat > MAX_LAT + 0.05) {
          map.panTo([MAX_LAT, c.lng], { animate: true, duration: 0.4 });
        } else if (c.lat < -MAX_LAT - 0.05) {
          map.panTo([-MAX_LAT, c.lng], { animate: true, duration: 0.4 });
        }
      });

      // インプット入力
      document.getElementById('dome-input').addEventListener('change', (e) => {
        onDomeCountChange(e.target.value);
      });

      // クイックボタン
      document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          onDomeCountChange(e.target.dataset.val);
        });
      });

      // スライダー（対数スケールで滑らかに増減する）
      document.getElementById('dome-slider').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        let count = Math.pow(10, val);
        // 小さな値は小数点第1位に丸め、大きな値は整数に丸める
        count = count < 1 ? Math.round(count * 10) / 10 : Math.round(count);
        if (count > MAX_DOME_COUNT) count = MAX_DOME_COUNT;
        // スライダー自身は動かしているので updateSlider は false
        onDomeCountChange(count, false); 
      });

      // スライダー（変形）
      document.getElementById('sides-slider').addEventListener('input', (e) => {
        shapeSides = parseInt(e.target.value);
        document.getElementById('shape-name').innerText = shapeSides >= 30 ? "円" : `${shapeSides}角形`;
        updateDomeShape();
      });

      document.getElementById('aspect-slider').addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        if (val > 0) {
          shapeAspect = 1 + (val / 100) * 9; 
        } else if (val < 0) {
          shapeAspect = 1 / (1 + (-val / 100) * 9); 
        } else {
          shapeAspect = 1.0;
        }
        updateDomeShape();
      });

      // 新設：回転（向き）スライダー
      document.getElementById('rotation-slider').addEventListener('input', (e) => {
        shapeRotation = parseInt(e.target.value);
        updateDomeShape();
      });

      // 下部ボタン
      document.getElementById('btn-home').addEventListener('click', () => {
        if (map) map.flyTo([L_lat, L_lon], 15, { duration: 1.5 });
      });

      document.getElementById('btn-current-location').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              if (map) map.flyTo([pos.coords.latitude, pos.coords.longitude], 15, { duration: 1.5 });
            },
            () => {
              showToast('現在地の取得が許可されていないか、取得に失敗しました。');
            }
          );
        } else {
          showToast('お使いのブラウザは現在地取得に対応していません。');
        }
      });

      // 初回の描画
      updateDomeShape(); 
    };
  </script>
</body>
</html>
